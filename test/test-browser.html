<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Test</title>
  <script type="text/javascript">
    // Intentionally global: Used for NPM-style imports in sax.js and clarinet.js.
    exports = {}
  </script>
  <script type="text/javascript" src="../lib/jquery-1.7.2-min.js"></script>
  <script type="text/javascript" src="../utils.js"></script>
  <script type="text/javascript" src="../lib/sax.js"></script>
  <script type="text/javascript" src="../lib/clarinet.js"></script>
  <script type="text/javascript" src="../xml-highlight.js"></script>
  <script type="text/javascript" src="../json-highlight.js"></script>
  <script type="text/javascript" src="test-browser.js"></script>
  <script type="text/javascript">
    $(document).ready(function(evt) {
      var tests = [
      {
        "name": "Simple XML",
        "type": "xml",
        "input": '<asdf attr="a" xmlns="xxx">asdf</asdf>',
        "assertions": ["xpath('/asdf:asdf/text()') === 'asdf'", 'xpath("/asdf:asdf/@attr") === "a"'], 
        "tests": function(data) { xpath('/asdf:asdf')}, // TODO
        "namespaceResolver": function(prefix) {
          return ({
            'asdf' : 'xxx'
          })[prefix] || null;
        }
      },
      {
        "name": "Simple JSON",
        "type": "json",
        "input": '[ { "lastName": "Gretzky", "firstName": "Wayne", "active": false, "teams": [ "Edmonton", "Los Angeles", "St. Louis", "New York" ], "jerseyNumber": 99 }, { "lastName": "Lemieux", "firstName": "Mario", "active": false, "teams": [ "Pittsburgh" ], "jerseyNumber": 66 } ]',
        "assertions": ["data.length === 2", "data[0].firstName === 'Wayne'", "data[1].jerseyNumber === 66"],
        "tests": function(data) { assertEquals(data.length, 2); data[0].firstName === 'Wayne'; data[1].jerseyNumber === 66; } // TODO
      },
      {
        "name": "Auctions (small)",
        "type": "json",
        "inputHref": "auctions-small.json",
        "assertions": ['data.realm.name === "Aegwynn"', 'data.realm.name === "Aegwynn"']
      },
      {
        "name": "Auctions (large)",
        "type": "json",
        "inputHref": "auctions-small.json",
        "assertions": ['asdf === 4']
      }
      ];
      function renderResult(result) {
        //console.dir(result);
        var acc = [];
        for(var i = 0; i < result.outcomes.length; i++) {
          var outcome = result.outcomes[i];
          acc.push('<tr class="outcome '+(outcome.isPassed ? 'passed' : 'failed')+'">');
          acc.push('<td class="outcome-test">'+outcome.test+'</td>');
          acc.push('<td class="outcome-result">'+(outcome.result ? outcome.result : '')+'</td>');
          acc.push('</tr>'); // closes div.outcome
        }
        $("#results").append('<tr class="test"><td colspan="2">'+result.test.name+'</td></tr>' + acc.join(""));
      }
      
      var results = [];
      for(var i = 0; i < tests.length ; i++) {
        var test = tests[i];
        var input;
        function handleOutcomes(html, test) {
          //console.timeEnd(test.name + " render");
          //console.time(test.name + " test");
          var outcomes = testStuff(test.type, html, test);
          var result = {
            "test": test,
            "isPassed": (outcomes.length > 0),
            "outcomes": outcomes
          }
          //console.dir(test);
          results.push(result);
          renderResult(result);
          console.timeEnd(test.name + " test");
        }
        
        function hi(test, input) {
          console.dir(test);
          console.time(test.name + " render");
          switch(test.type) {
            case "json":
              highlightJSON(input, function(html) { return handleOutcomes(html, test) }, null, function(err) { console.error(err)});
            break;
            case "xml":
              highlight(input, function(html) { return handleOutcomes(html, test) }, null, function(err) { console.error(err)});
            break;
            default: throw test.type + " is not a valid type";
          }
        }

        if(test.inputHref) {
          console.time(test.name + " get data");
          var xhr = new XMLHttpRequest();
          xhr.test = test;
          xhr.onreadystatechange = function() {
            if(this.readyState === 1) { /* Loading */ }
            if(this.readyState === 4) {
              console.timeEnd(test.name + " get data");
              if (this.status >= 200 && this.status < 300) {
                //console.log("END REDYSTATE " + this.test.name);
                hi(this.test, this.responseText);
              } else {
                console.error(this.responseText);
              }
            }
          }
          xhr.open("GET", test.inputHref, true);
          xhr.setRequestHeader("Accept", "application/json");
          xhr.send();
        } else {
          hi(test, test.input);
        }
      }
    });
  </script>
  <style type="text/css">
    .passed { color: green;}
    .failed { color: red;}
    .test { font-weight: bold;}
    table#results {
      width: 80%;
    }
    td, th {
      border: solid 1px #ccc;
      padding: 0.5em;
    }
    body {
      font-family: Helvetica, sans-serif;
    }
  </style>
</head>
<body>
<h1>Results</h1>
<table id="results">
  <col></col>
  <col></col>
</table>
</body>
</html>
